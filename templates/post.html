{% extends 'base.html' %}
{% block content %}

{% if session.user %}
<div class="create-post-wrapper">

    <!-- THEME CONTROLS -->
    <div class="color-picker-section">
        <label>Background</label>
        <input type="color" id="bgColor" value="#0b0b0f">

        <label>Accent</label>
        <input type="color" id="accentColor" value="#8b5cf6">

        <button type="button" id="resetColors">Reset</button>
    </div>

    <!-- COMPOSER -->
    <form class="post-card" action="/create_post" method="POST" enctype="multipart/form-data">

        <!-- USER -->
        <div class="post-user">
            <div class="avatar"></div>
            <div>
                <strong>@{{ session['user'] }}</strong>
                <span class="visibility">Public post</span>
            </div>
        </div>

        <!-- INPUT -->
        <textarea
            name="content"
            id="postContent"
            placeholder="What‚Äôs happening?"
            maxlength="2000"
            required></textarea>

        <div class="post-meta">
            <span id="charCount">0 / 2000</span>
        </div>

        <!-- IMAGE -->
        <div class="image-preview" id="imagePreview" style="display:none;">
            <img id="previewImg">
            <button type="button" onclick="removeImage()">‚úï</button>
        </div>

        <!-- ACTIONS -->
        <div class="post-actions">
            <div class="left-actions">
                <label class="icon-btn">
                    üì∑
                    <input type="file" name="image" accept="image/*" hidden onchange="previewImage(event)">
                </label>

                <!-- EMOJI PICKER BUTTON -->
                <button type="button" class="icon-btn" id="emojiToggle">üòä</button>
            </div>

            <select name="visibility">
                <option value="public">üåç Public</option>
                <option value="followers">üë• Followers</option>
                <option value="private">üîí Private</option>
            </select>
        </div>

        <!-- EMOJI PANEL -->
        <div class="emoji-panel" id="emojiPanel">
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>

        <!-- TAGS -->
        <input
            type="text"
            name="tags"
            class="tags-input"
            placeholder="#tags (ai, creators, growth)">

        <!-- SUBMIT -->
        <div class="submit-bar">
            <a href="/community" class="cancel">Cancel</a>
            <button type="submit" class="submit-btn">Post</button>
        </div>

    </form>
</div>
{% endif %}

<script>
const textarea = document.getElementById("postContent");
const charCount = document.getElementById("charCount");
const root = document.documentElement;

textarea.addEventListener("input", () => {
    charCount.textContent = `${textarea.value.length} / 2000`;
});

/* IMAGE */
function previewImage(e) {
    document.getElementById("previewImg").src = URL.createObjectURL(e.target.files[0]);
    document.getElementById("imagePreview").style.display = "block";
}
function removeImage() {
    document.getElementById("imagePreview").style.display = "none";
    document.querySelector('input[type="file"]').value = "";
}

/* EMOJI PICKER */
const emojiToggle = document.getElementById("emojiToggle");
const emojiPanel = document.getElementById("emojiPanel");
const emojiGrid = document.getElementById("emojiGrid");

const emojis = [
    "üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòâ","üòä","üòç","ü§©","üòò",
    "üòé","ü§î","üòÆ","üò±","üò°","ü•∂","ü•µ","ü§Ø","ü•≥","üî•",
    "‚ö°","üöÄ","üíé","‚ú®","üåà","üß†","üí°","üéØ","üìà","üí¨",
    "‚ù§Ô∏è","üñ§","üíú","üíô","üíö","ü§ç","üí•","üëÄ","üôå","üëè"
];

emojiToggle.onclick = () => {
    emojiPanel.classList.toggle("open");
};

emojis.forEach(e => {
    const span = document.createElement("span");
    span.className = "emoji-item";
    span.textContent = e;
    span.onclick = () => {
        textarea.value += e;
        textarea.dispatchEvent(new Event("input"));
        emojiPanel.classList.remove("open");
    };
    emojiGrid.appendChild(span);
});

/* THEME */
const bgPicker = document.getElementById("bgColor");
const accentPicker = document.getElementById("accentColor");

function updateColors(bg, accent) {
    root.style.setProperty("--bg", bg);
    root.style.setProperty("--accent", accent);
    root.style.setProperty("--accent-soft", lighten(accent, 30));
    root.style.setProperty("--accent-deep", darken(accent, 20));
    root.style.setProperty(
        "--accent-gradient",
        `linear-gradient(135deg, ${accent}, ${lighten(accent,30)})`
    );
    root.style.setProperty("--text", brightness(bg) > 140 ? "#0b0b0f" : "#ffffff");
}

bgPicker.oninput = e => updateColors(e.target.value, accentPicker.value);
accentPicker.oninput = e => updateColors(bgPicker.value, e.target.value);

document.getElementById("resetColors").onclick = () => {
    bgPicker.value = "#0b0b0f";
    accentPicker.value = "#8b5cf6";
    updateColors("#0b0b0f", "#8b5cf6");
};

function lighten(h,p){let r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);r+=(255-r)*p/100;g+=(255-g)*p/100;b+=(255-b)*p/100;return`#${[r,g,b].map(x=>Math.min(255,Math.floor(x)).toString(16).padStart(2,"0")).join("")}`;}
function darken(h,p){let r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);r*=1-p/100;g*=1-p/100;b*=1-p/100;return`#${[r,g,b].map(x=>Math.max(0,Math.floor(x)).toString(16).padStart(2,"0")).join("")}`;}
function brightness(h){const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return(r*299+g*587+b*114)/1000;}
</script>

<style>
:root {
    --bg:#0b0b0f;
    --text:#fff;
    --accent:#8b5cf6;
    --accent-soft:#a78bfa;
    --accent-deep:#6d28d9;
    --accent-gradient:linear-gradient(135deg,#8b5cf6,#22d3ee);
}

body { background:var(--bg); color:var(--text); }

/* WRAPPER */
.create-post-wrapper {
    max-width:960px;
    margin:auto;
    padding:32px 16px;
}

/* CARD */
.post-card {
    background:color-mix(in srgb,var(--bg) 85%,white 15%);
    border-radius:22px;
    padding:24px;
    border:1px solid color-mix(in srgb,var(--accent) 35%,transparent);
    box-shadow:0 20px 60px rgba(0,0,0,.45);
}

/* USER */
.post-user { display:flex; gap:14px; align-items:center; margin-bottom:18px; }
.avatar { width:52px; height:52px; border-radius:50%; background:var(--accent-gradient); }

/* INPUT */
textarea {
    width:100%;
    min-height:120px;
    background:transparent;
    border:none;
    font-size:20px;
    color:var(--text);
    resize:none;
}
textarea:focus { outline:none; }

/* ACTIONS */
.post-actions { display:flex; justify-content:space-between; margin:18px 0; }
.icon-btn {
    background:color-mix(in srgb,var(--bg) 80%,white 20%);
    border:none;
    border-radius:14px;
    padding:10px 14px;
    font-size:20px;
    cursor:pointer;
}

/* EMOJI PANEL */
.emoji-panel {
    display:none;
    margin-bottom:20px;
}
.emoji-panel.open {
    display:block;
}
.emoji-grid {
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(42px,1fr));
    gap:10px;
    padding:14px;
    border-radius:16px;
    background:color-mix(in srgb,var(--bg) 85%,white 15%);
}
.emoji-item {
    font-size:22px;
    text-align:center;
    cursor:pointer;
    filter: drop-shadow(0 0 6px var(--accent-soft));
    transition: transform .15s ease;
}
.emoji-item:hover {
    transform: scale(1.25);
}

/* TAGS */
.tags-input {
    width:100%;
    padding:14px;
    border-radius:14px;
    border:none;
    background:color-mix(in srgb,var(--bg) 85%,white 15%);
    color:var(--text);
    margin-bottom:22px;
}

/* SUBMIT */
.submit-bar { display:flex; justify-content:space-between; }
.submit-btn {
    background:var(--accent-gradient);
    border:none;
    padding:14px 34px;
    border-radius:16px;
    font-weight:800;
    color:white;
    cursor:pointer;
}
</style>

{% endblock %}
