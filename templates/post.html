{% extends 'base.html' %}
{% block content %}

{% if session.user %}
<div class="create-post-wrapper">

    <!-- THEME CONTROLS -->
    <div class="color-picker-section">
        <label>Background</label>
        <input type="color" id="bgColor" value="#0b0b0f">

        <label>Accent</label>
        <input type="color" id="accentColor" value="#8b5cf6">

        <button type="button" id="resetColors">Reset</button>
    </div>

    <!-- COMPOSER -->
    <form class="post-card" action="/create_post" method="POST" enctype="multipart/form-data">

        <!-- USER -->
        <div class="post-user">
            <div class="avatar"></div>
            <div>
                <strong>@{{ session['user'] }}</strong>
                <span class="visibility">Public post</span>
            </div>
        </div>

        <!-- TEXT -->
        <textarea
            name="content"
            id="postContent"
            placeholder="What‚Äôs happening?"
            maxlength="2000"
            required></textarea>

        <div class="post-meta">
            <span id="charCount">0 / 2000</span>
        </div>

        <!-- IMAGE -->
        <div class="image-preview" id="imagePreview" style="display:none;">
            <img id="previewImg">
            <button type="button" onclick="removeImage()">‚úï</button>
        </div>

        <!-- ACTIONS -->
        <div class="post-actions">
            <div class="left-actions">
                <label class="icon-btn" title="Add image">
                    üì∑
                    <input type="file" name="image" accept="image/*" hidden onchange="previewImage(event)">
                </label>

                <button type="button" class="icon-btn" id="emojiToggle" title="Add emoji">üòä</button>
            </div>

            <select name="visibility">
                <option value="public">üåç Public</option>
                <option value="followers">üë• Followers</option>
                <option value="private">üîí Private</option>
            </select>
        </div>

        <!-- EMOJI PANEL -->
        <div class="emoji-panel" id="emojiPanel">
            <div class="emoji-tabs">
                <button data-tab="recent">Recent</button>
                <button data-tab="faces" class="active">Faces</button>
                <button data-tab="symbols">Symbols</button>
            </div>
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>

        <!-- TAGS -->
        <input
            type="text"
            name="tags"
            class="tags-input"
            placeholder="#tags (ai, creators, growth)">

        <!-- SUBMIT -->
        <div class="submit-bar">
            <a href="/community" class="cancel">Cancel</a>
            <button type="submit" class="submit-btn" id="submitBtn" disabled>Post</button>
        </div>

    </form>
</div>
{% endif %}

<script>
const textarea = document.getElementById("postContent");
const charCount = document.getElementById("charCount");
const submitBtn = document.getElementById("submitBtn");
const root = document.documentElement;

/* ---------------- TEXTAREA ---------------- */
function autoGrow() {
    textarea.style.height = "auto";
    textarea.style.height = textarea.scrollHeight + "px";
}
textarea.addEventListener("input", () => {
    autoGrow();
    charCount.textContent = `${textarea.value.length} / 2000`;
    submitBtn.disabled = textarea.value.trim().length === 0;
    localStorage.setItem("draft_text", textarea.value);
});
autoGrow();

/* Restore draft */
const savedDraft = localStorage.getItem("draft_text");
if (savedDraft) {
    textarea.value = savedDraft;
    textarea.dispatchEvent(new Event("input"));
}

/* ---------------- IMAGE ---------------- */
function previewImage(e) {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById("previewImg").src = URL.createObjectURL(file);
    document.getElementById("imagePreview").style.display = "block";
}
function removeImage() {
    document.getElementById("imagePreview").style.display = "none";
    document.querySelector('input[type="file"]').value = "";
}

/* ---------------- EMOJI SYSTEM ---------------- */
const emojiToggle = document.getElementById("emojiToggle");
const emojiPanel = document.getElementById("emojiPanel");
const emojiGrid = document.getElementById("emojiGrid");

const emojiSets = {
    faces: ["üòÄ","üòÑ","üòÅ","üòâ","üòä","üòç","ü§©","üòé","ü§î","üòÆ","üò±","ü•≥"],
    symbols: ["üî•","‚ú®","‚ö°","üöÄ","üíé","üéØ","üìà","üí°","‚ù§Ô∏è","üñ§","üíú"],
};

function getRecent() {
    return JSON.parse(localStorage.getItem("recent_emojis") || "[]");
}
function saveRecent(e) {
    let r = getRecent().filter(x => x !== e);
    r.unshift(e);
    localStorage.setItem("recent_emojis", JSON.stringify(r.slice(0, 12)));
}

function loadEmojis(type) {
    emojiGrid.innerHTML = "";
    const list = type === "recent" ? getRecent() : emojiSets[type];
    list.forEach(e => {
        const s = document.createElement("span");
        s.className = "emoji-item";
        s.textContent = e;
        s.onclick = () => {
            textarea.value += e;
            textarea.dispatchEvent(new Event("input"));
            saveRecent(e);
            emojiPanel.classList.remove("open");
        };
        emojiGrid.appendChild(s);
    });
}

emojiToggle.onclick = () => emojiPanel.classList.toggle("open");
document.addEventListener("click", e => {
    if (!emojiPanel.contains(e.target) && e.target !== emojiToggle) {
        emojiPanel.classList.remove("open");
    }
});
document.addEventListener("keydown", e => {
    if (e.key === "Escape") emojiPanel.classList.remove("open");
});

/* Tabs */
document.querySelectorAll(".emoji-tabs button").forEach(b => {
    b.onclick = () => {
        document.querySelectorAll(".emoji-tabs button").forEach(x => x.classList.remove("active"));
        b.classList.add("active");
        loadEmojis(b.dataset.tab);
    };
});
loadEmojis("faces");

/* ---------------- THEME ---------------- */
const bgPicker = document.getElementById("bgColor");
const accentPicker = document.getElementById("accentColor");

function updateColors(bg, accent) {
    root.style.setProperty("--bg", bg);
    root.style.setProperty("--accent", accent);
    root.style.setProperty("--accent-soft", lighten(accent, 30));
    root.style.setProperty("--accent-deep", darken(accent, 20));
    root.style.setProperty("--accent-gradient", `linear-gradient(135deg, ${accent}, ${lighten(accent,30)})`);
    root.style.setProperty("--text", brightness(bg) > 140 ? "#0b0b0f" : "#ffffff");
    localStorage.setItem("theme", JSON.stringify({ bg, accent }));
}

const savedTheme = JSON.parse(localStorage.getItem("theme") || "null");
if (savedTheme) {
    bgPicker.value = savedTheme.bg;
    accentPicker.value = savedTheme.accent;
    updateColors(savedTheme.bg, savedTheme.accent);
}

bgPicker.oninput = e => updateColors(e.target.value, accentPicker.value);
accentPicker.oninput = e => updateColors(bgPicker.value, e.target.value);
document.getElementById("resetColors").onclick = () => updateColors("#0b0b0f","#8b5cf6");

function lighten(h,p){let r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);r+=(255-r)*p/100;g+=(255-g)*p/100;b+=(255-b)*p/100;return`#${[r,g,b].map(x=>Math.min(255,Math.floor(x)).toString(16).padStart(2,"0")).join("")}`;}
function darken(h,p){let r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);r*=1-p/100;g*=1-p/100;b*=1-p/100;return`#${[r,g,b].map(x=>Math.max(0,Math.floor(x)).toString(16).padStart(2,"0")).join("")}`;}
function brightness(h){const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return(r*299+g*587+b*114)/1000;}
</script>

<style>
:root {
    --bg:#0b0b0f;
    --text:#fff;
    --accent:#8b5cf6;
    --accent-soft:#a78bfa;
    --accent-deep:#6d28d9;
    --accent-gradient:linear-gradient(135deg,#8b5cf6,#22d3ee);
}
body { background:var(--bg); color:var(--text); }

/* WRAPPER */
.create-post-wrapper {
    max-width: 980px;
    margin: auto;
    padding: 36px 16px;
}

/* CARD */
.post-card {
    background: color-mix(in srgb, var(--bg) 88%, white 12%);
    border-radius: 26px;
    padding: 26px;
    border: 1px solid color-mix(in srgb, var(--accent) 30%, transparent);
    box-shadow: 0 24px 80px rgba(0,0,0,.45);
}

/* USER */
.post-user { display:flex; gap:16px; align-items:center; margin-bottom:18px; }
.avatar { width:56px; height:56px; border-radius:50%; background:var(--accent-gradient); }

/* TEXT */
textarea {
    width:100%;
    min-height:120px;
    background:transparent;
    border:none;
    font-size:21px;
    line-height:1.5;
    color:var(--text);
    resize:none;
}
textarea::placeholder { opacity:.55; }
textarea:focus { outline:none; }

/* META */
.post-meta { text-align:right; font-size:14px; opacity:.6; }

/* ACTIONS */
.post-actions {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin:18px 0;
}
.icon-btn {
    background:color-mix(in srgb,var(--bg) 80%,white 20%);
    border:none;
    border-radius:14px;
    padding:10px 14px;
    font-size:20px;
    cursor:pointer;
    transition:transform .15s ease;
}
.icon-btn:hover { transform:translateY(-1px); }

/* EMOJI PANEL */
.emoji-panel { display:none; margin-bottom:18px; }
.emoji-panel.open { display:block; }
.emoji-tabs {
    display:flex;
    gap:8px;
    margin-bottom:8px;
}
.emoji-tabs button {
    background:transparent;
    border:none;
    color:var(--text);
    opacity:.6;
    cursor:pointer;
}
.emoji-tabs button.active { opacity:1; }
.emoji-grid {
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(42px,1fr));
    gap:10px;
    padding:14px;
    border-radius:16px;
    background:color-mix(in srgb,var(--bg) 85%,white 15%);
}
.emoji-item {
    font-size:22px;
    text-align:center;
    cursor:pointer;
    filter:drop-shadow(0 0 6px var(--accent-soft));
    transition:transform .15s ease;
}
.emoji-item:hover { transform:scale(1.25); }

/* TAGS */
.tags-input {
    width:100%;
    padding:14px;
    border-radius:14px;
    border:none;
    background:color-mix(in srgb,var(--bg) 85%,white 15%);
    color:var(--text);
    margin-bottom:24px;
}

/* SUBMIT */
.submit-bar { display:flex; justify-content:space-between; align-items:center; }
.submit-btn {
    background:var(--accent-gradient);
    border:none;
    padding:14px 36px;
    border-radius:16px;
    font-weight:800;
    color:white;
    cursor:pointer;
    opacity:.5;
}
.submit-btn:not(:disabled) { opacity:1; }
</style>

{% endblock %}
